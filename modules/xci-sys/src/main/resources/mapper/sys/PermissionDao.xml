<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2007-2020 西安交通信息投资营运有限公司 版权所有
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.github.lvyanyang.sys.dao.PermissionDao">
    <!--region 用户拥有的模块权限 -->
    <select id="selectUserModuleList" resultType="com.github.lvyanyang.sys.entity.SysModule">
        select <include refid="com.github.lvyanyang.sys.dao.ModuleDao.columns"/>
        from (
            select <include refid="com.github.lvyanyang.sys.dao.ModuleDao.columns"/>
            from sys_module
            where status=1 and publiced=1
            union
            select <include refid="com.github.lvyanyang.sys.dao.ModuleDao.columns"/>
            from sys_module m inner join
                 (
                     select distinct target_id module_id
                     from sys_object_map
                     where object_name='role'
                       and object_id in
                           (
                               select r.id role_id from sys_role r join sys_user_role_map urmap
                                on r.status=1 and urmap.user_id=#{userId} and urmap.role_id=r.id
                           )
                       and target_name='module'
                 ) map
                 on m.status=1 and map.module_id=m.id
             ) x
        order by x.parent_id asc, x.path asc
    </select>
    <!--endregion -->

    <!--region 用户拥有的机构权限 -->
    <select id="selectUserDeptDataList" resultType="com.github.lvyanyang.sys.entity.SysDept">
        <include refid="com.github.lvyanyang.sys.dao.DeptDao.select"/>
        where d.id in (
            select distinct target_id
            from sys_object_map
            where object_name = 'role'
              and object_id in
                  (
                      select r.id role_id
                      from sys_role r join sys_user_role_map urmap
                          on r.status = 1 and urmap.user_id = ${userId}
                                 and urmap.role_id = r.id
                  )
              and target_name = 'dept'
        )
    </select>
    <!--endregion -->


    <!--region 根据角色主键查询模块对象列表-->
    <select id="selectRoleModuleList" resultType="com.github.lvyanyang.sys.entity.SysModule">
        select
        <include refid="com.github.lvyanyang.sys.dao.ModuleDao.columns"/>
        from sys_module
        where status = 1 and id in (
            select distinct target_id from sys_object_map where object_name='role' and object_id = #{roleId} and target_name='module'
        )
        order by parent_id asc,path asc
    </select>
    <!--endregion-->

    <!--region 根据角色主键查询机构数据权限对象列表-->
    <select id="selectRoleDeptDataList" resultType="com.github.lvyanyang.sys.entity.SysDept">
        <include refid="com.github.lvyanyang.sys.dao.DeptDao.select"/>
        where d.status = 1 and d.id in (
            select distinct target_id from sys_object_map where object_name='role' and object_id = #{roleId} and target_name='dept.data'
        )
        order by d.parent_id asc,d.path asc
    </select>
    <!--endregion-->
</mapper>