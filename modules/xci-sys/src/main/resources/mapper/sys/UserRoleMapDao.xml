<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2007-2020 西安交通信息投资营运有限公司 版权所有
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.github.lvyanyang.sys.dao.UserRoleMapDao">
    <!--region 新建-->
    <insert id="insert">
        insert into sys_user_role_map (user_id, role_id)
        values (#{userId}, #{roleId})
    </insert>
    <!--endregion-->

    <!--region 删除关联-->
    <delete id="delete">
        delete
        from sys_user_role_map
        where user_id = #{userId} and role_id = #{roleId}
    </delete>
    <!--endregion-->

    <!--region 根据用户主键删除关联-->
    <delete id="clearMapRole">
        delete
        from sys_user_role_map
        where user_id = #{userId}
    </delete>
    <!--endregion-->

    <!--region 根据角色主键删除关联-->
    <delete id="clearMapUser">
        delete
        from sys_user_role_map
        where role_id = #{roleId}
    </delete>
    <!--endregion-->

    <!--#region 查询用户-->

    <!--region 根据角色主键查询已关联的用户主键列表-->
    <select id="selectMapUserIds" resultType="string">
        select id
        from sys_user u
        where u.deleted = 0
          and u.status = 1
          and exists(
                select 1 from sys_user_role_map map where map.role_id = #{roleId} and map.user_id = u.id
            )
    </select>
    <!--endregion-->

    <!--region 根据角色主键查询已关联的用户列表-->
    <select id="selectMapUserList" resultType="com.github.lvyanyang.sys.entity.SysUser">
        <include refid="com.github.lvyanyang.sys.dao.UserDao.select"/>
        where u.deleted=0
        and u.status = 1
        and exists (
        select 1 from sys_user_role_map map where map.role_id = #{roleId} and map.user_id = u.id
        )
    </select>
    <!--endregion-->

    <!--region 根据角色主键查询未关联的用户主键列表-->
    <select id="selectUnMapUserIds" resultType="string">
        select id
        from sys_user u
        where u.deleted = 0
          and u.status = 1
          and not exists(
                select 1 from sys_user_role_map map where map.role_id = #{roleId} and map.user_id = u.id
            )
    </select>
    <!--endregion-->

    <!--region 根据角色主键查询未关联的用户列表-->
    <select id="selectUnMapUserList" resultType="com.github.lvyanyang.sys.entity.SysUser">
        <include refid="com.github.lvyanyang.sys.dao.UserDao.select"/>
        where u.deleted=0
        and u.status = 1
        and not exists (
        select 1 from sys_user_role_map map where map.role_id = #{roleId} and map.user_id = u.id
        )
    </select>
    <!--endregion-->

    <!--#endregion-->

    <!--#region 查询角色-->

    <!--region 根据用户主键查询已关联的角色主键列表-->
    <select id="selectMapRoleIds" resultType="string">
        select r.id
        from sys_role r
        where r.status = 1
          and exists(
                select 1 from sys_user_role_map map where map.user_id = #{userId} and map.role_id = r.id
            )
    </select>
    <!--endregion-->

    <!--region 根据用户主键查询已关联的角色列表-->
    <select id="selectMapRoleList" resultType="com.github.lvyanyang.sys.entity.SysRole">
        <include refid="com.github.lvyanyang.sys.dao.RoleDao.select"/>
        where r.status=1
        and exists (
        select 1 from sys_user_role_map map where map.user_id = #{userId} and map.role_id = r.id
        )
    </select>
    <!--endregion-->

    <!--region 根据用户主键查询未关联的角色主键列表-->
    <select id="selectUnMapRoleIds" resultType="string">
        select r.id
        from sys_role r
        where r.status = 1
          and not exists(
                select 1 from sys_user_role_map map where map.user_id = #{userId} and map.role_id = r.id
            )
    </select>
    <!--endregion-->

    <!--region 根据用户主键查询未关联的角色列表-->
    <select id="selectUnMapRoleList" resultType="com.github.lvyanyang.sys.entity.SysRole">
        <include refid="com.github.lvyanyang.sys.dao.RoleDao.select"/>
        where r.status=1 and not exists (
        select 1 from sys_user_role_map map where map.user_id = #{userId} and map.role_id = r.id
        )
    </select>
    <!--endregion-->

    <!--#endregion-->
</mapper>